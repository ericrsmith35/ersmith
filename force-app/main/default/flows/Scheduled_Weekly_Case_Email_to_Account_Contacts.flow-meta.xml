<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Send_Email</name>
        <label>Send Email</label>
        <locationX>765</locationX>
        <locationY>502</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>vEmailBody</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <elementReference>ttSubject</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>senderAddress</name>
            <value>
                <elementReference>vAccountOwnerEmail</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <elementReference>ttSendTo</elementReference>
            </value>
        </inputParameters>
    </actionCalls>
    <assignments>
        <name>Add_LineBreak</name>
        <label>Add LineBreak</label>
        <locationX>1199</locationX>
        <locationY>770</locationY>
        <assignmentItems>
            <assignToReference>vEmailBody</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>fCRLF</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Account_s_Cases</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_Report</name>
        <label>Add to Report</label>
        <locationX>994</locationX>
        <locationY>765</locationY>
        <assignmentItems>
            <assignToReference>vEmailBody</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>ttCaseDetail</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_LineBreak</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Do_Nothing</name>
        <label>Do Nothing</label>
        <locationX>34</locationX>
        <locationY>28</locationY>
        <assignmentItems>
            <assignToReference>vTest</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vAccountId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>0013200001E1i3hAAB</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Support_Trouble_ID</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Save_Case_Fields</name>
        <label>Save Case Fields</label>
        <locationX>789</locationX>
        <locationY>761</locationY>
        <assignmentItems>
            <assignToReference>vcCaseNumber</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.CaseNumber</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcSubject</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.Subject</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcCreatedDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.CreatedDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcDescription</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.Description</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcStatus</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.Status</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcClosedDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.ClosedDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcCase_Closed_Comments</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.Case_Closed_Comments__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vcResolved_By</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>objCase.Resolved_By__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_Report</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Found_Cases</name>
        <label>Found Cases?</label>
        <locationX>378</locationX>
        <locationY>246</locationY>
        <defaultConnectorLabel>NONE</defaultConnectorLabel>
        <rules>
            <name>YESc</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>colAccountCases</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Account_Data</targetReference>
            </connector>
            <label>YES</label>
        </rules>
    </decisions>
    <description>Case #49866 - Email an Account contact whenever a Case is opened or closed and provide a weekly report of Case activity.

This Flow will be run through the Mass Action Scheduler</description>
    <formulas>
        <name>fCRLF</name>
        <dataType>String</dataType>
        <expression>SUBSTITUTE({!$Label.LineBreak},&quot;-&quot;,&quot;&quot;)</expression>
    </formulas>
    <formulas>
        <name>fStartDate</name>
        <dataType>Date</dataType>
        <expression>TODAY() - 7</expression>
    </formulas>
    <interviewLabel>Scheduled - Weekly Case Email to Account Contacts {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Scheduled - Weekly Case Email to Account Contacts</label>
    <loops>
        <name>Loop_Account_s_Cases</name>
        <label>Loop Account&#39;s Cases</label>
        <locationX>576</locationX>
        <locationY>618</locationY>
        <assignNextValueToReference>objCase</assignNextValueToReference>
        <collectionReference>colAccountCases</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Case_Contact_Name</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Send_Email</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Account_Case_Contact_Email</name>
        <label>Get Account Case Contact Email</label>
        <locationX>386</locationX>
        <locationY>615</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_Account_s_Cases</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vAccountCaseContactID</elementReference>
            </value>
        </filters>
        <object>Contact</object>
        <outputAssignments>
            <assignToReference>vAccountCaseContactEmail</assignToReference>
            <field>Email</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Get_Account_Data</name>
        <label>Get Account Data</label>
        <locationX>384</locationX>
        <locationY>364</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Owner_Email</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vAccountId</elementReference>
            </value>
        </filters>
        <object>Account</object>
        <outputAssignments>
            <assignToReference>vAccountCaseContactID</assignToReference>
            <field>Case_Contact__c</field>
        </outputAssignments>
        <outputAssignments>
            <assignToReference>vOwnerId</assignToReference>
            <field>OwnerId</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Get_Case_Contact_Name</name>
        <label>Get Case Contact Name</label>
        <locationX>580</locationX>
        <locationY>758</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Save_Case_Fields</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>objCase.ContactId</elementReference>
            </value>
        </filters>
        <object>Contact</object>
        <outputAssignments>
            <assignToReference>vCaseContactName</assignToReference>
            <field>Name</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Get_Cases_from_This_Week</name>
        <label>Get Cases from This Week</label>
        <locationX>185</locationX>
        <locationY>245</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Found_Cases</targetReference>
        </connector>
        <filters>
            <field>AccountId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vAccountId</elementReference>
            </value>
        </filters>
        <filters>
            <field>IsReportable__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>RecordTypeId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vSupportTroubleID</elementReference>
            </value>
        </filters>
        <object>Case</object>
        <outputReference>colAccountCases</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>CaseNumber</queriedFields>
        <queriedFields>Subject</queriedFields>
        <queriedFields>ContactId</queriedFields>
        <queriedFields>CreatedDate</queriedFields>
        <queriedFields>Description</queriedFields>
        <queriedFields>Status</queriedFields>
        <queriedFields>ClosedDate</queriedFields>
        <queriedFields>Reason</queriedFields>
        <queriedFields>Case_Closed_Comments__c</queriedFields>
        <queriedFields>Resolved_By__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_Owner_Email</name>
        <label>Get Owner Email</label>
        <locationX>384</locationX>
        <locationY>488</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Account_Case_Contact_Email</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vOwnerId</elementReference>
            </value>
        </filters>
        <object>User</object>
        <outputAssignments>
            <assignToReference>vAccountOwnerEmail</assignToReference>
            <field>Email</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Support_Trouble_ID</name>
        <label>Support Trouble ID</label>
        <locationX>185</locationX>
        <locationY>132</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Cases_from_This_Week</targetReference>
        </connector>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Support_Trouble</stringValue>
            </value>
        </filters>
        <object>RecordType</object>
        <outputAssignments>
            <assignToReference>vSupportTroubleID</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <startElementReference>Support_Trouble_ID</startElementReference>
    <status>Active</status>
    <textTemplates>
        <name>ttCaseDetail</name>
        <text>Case #: {!vcCaseNumber}
Subject: {!vcSubject}

Date Opened: {!vcCreatedDate}
Contact: {!vCaseContactName}
Description: {!vcDescription}

Status: {!vcStatus}

Date Closed: {!vcClosedDate}
Resolved By: {!vcResolved_By}
Closed Comments: {!vcCase_Closed_Comments}

--------------------------------------------------------------------------------------------------</text>
    </textTemplates>
    <textTemplates>
        <name>ttSendTo</name>
        <text>{!vAccountCaseContactEmail}, {!vAccountOwnerEmail}</text>
    </textTemplates>
    <textTemplates>
        <name>ttSubject</name>
        <text>Weekly GWI Support Trouble Cases Report - {!$Flow.CurrentDate}</text>
    </textTemplates>
    <variables>
        <name>colAccountCases</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Case</objectType>
    </variables>
    <variables>
        <name>objAccount</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Account</objectType>
    </variables>
    <variables>
        <name>objCase</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Case</objectType>
    </variables>
    <variables>
        <name>vAccountCaseContactEmail</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vAccountCaseContactID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vAccountId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vAccountOwnerEmail</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vCaseContactName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcCase_Closed_Comments</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcCaseNumber</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcClosedDate</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcCreatedDate</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcDescription</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcResolved_By</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcStatus</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vcSubject</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vEmailBody</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vOwnerId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vSupportTroubleID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vTest</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
